---
title: hologram-project-exp
date: 2015-09-14
author: ielgnaw
author_link: http://weibo.com/justjava
tags:
- hologram
- exp
---


前段时间上线了全息机器人项目，直接在手机百度 APP 语音搜索 `百度神灯` 即可。这个项目在全息播放部分大约有 1800 多张图片，在手机以及 `ipad` 上运行，开发过程中遇到的问题比较多，这篇文章就从技术的角度来总结一下这个项目。

<!-- more -->

### 方案制定

最开始接到这个需求的时候，考虑过 SVG 以及 CSS3 的方案，但是后来没有采用这两种方案，主要原因是: 

1. 大家都知道 SVG 是一种在内存中持久保存的保留模式图形，而这个项目是一个单页应用，除去全息播放这块，还有将近十个引导页面，引导页面上也有一些动画，因此，考虑到 SVG 内存占用会比较高，因此就放弃了这个方案。
2. CSS3 动画性能上是 ok 的，但是由于大部分动画元素是带有交互效果的，而且 CSS3 动画无法精确的知道结束时间，因此也放弃了 CSS3 的方案。
3. 全息播放这块没有采用视频是因为在播放视屏的时候，实际上是调用手机自带播放器来播放，一开始会出现上下两个导航条（上方是进度控制导航，下方是音量控制导航），这不符合设计要求。
4. 由于我们的对 CANVAS 比较熟悉，之前也有一些积累，同时由于最开始的时候以为这个项目只是个 DEMO 以及时间比较紧迫，因此，最后决定使用 CANVAS + CSS3 + DOM 的方案来实现，CANVAS 来实现主体部分动画（包括全息播放）、CSS3 实现一些简单无交互的动画、简单的按钮以及文案则直接采用 DOM 来实现。

### 问题及应对方案

主要的问题大家其实应该可以看出来，就是全息播放这块的性能。共四组全息动画，第一组 415 张，第二组675 张，第三组 281 张，第四组 497 张。而且最开始设计师给的图质量比较高，1242 * 1242 px（这个时候和 UE、PM 沟通压缩图片并未允许）。第一组 415 张还好，android 机型勉强能撑过去，但是第二组 675 张时，android 大部分机型都挂掉了，iPhone 也有明显的卡顿。而且还有加载资源的问题，同时加载这么多图片资源，对内存本身的消耗也很大。针对这种情况，我们做了如下几种尝试：

- 直接加载图片
	+ canvas drawImage，每一帧里直接调用 canvas.drawImage。这种方案在中低端 android 机型中直接 crash；在 iPhone6/6p 机型中，如果开启很多其他应用的话，也会造成系统资源不够用，导致 crash。
	+ 动态创建 N 个 img 元素，render 前设置好每一个 img 元素的 src，然后通过 documentFragment append 到 document.body 上，每一帧切换相邻两个 img 元素的 opacity（前一个设置为 0，后一个设置为 1），形成动画效果。这种方式同样在中低端 android 机型上 crash。
	+ 创建一个 img 元素，每一帧变化对应的 img 元素的 src，这种方式不会 crash，但是会出现大幅度的跳帧，原因是切换 src 的时候，当前 src 的图片还没加载完就已经跳到下一帧了。
	+ 创建一个 div 元素，每一帧变化对应的 div 元素的 background-image，这种方式也不会 crash，但是也会出现跳帧，原因和上面创建一个 img 元素的方式一样，同时这种方案在 android 下会出现闪烁。

- 事先生成图片的 base64 串，然后加载 base64 串文件
	+ 生成 base64 串为一个 JSON 文件，key 为图片的名称，value 为 base64 串。在倒计时页面去加载这个 base64 的 JSON 文件，虽然把 JSON 文件按照 N / 10（倒计时为 10 秒）来分组，但相对来说，每一个 JSON 还是太大，JS 处理这么一个大的 JSON 对象对内存占用也比较高，而且紧接着就是全息动画播放，因此性能上还是扛不住。

最后，我们采用的方案是，事先生成图片的 base64 串，但并不组装成 JSON 对象，存的只是以 `\n` 分割的文本文件，在倒计时加载页面去加载当前这一组全息资源的 base64 文本文件，仅仅只是做加载，不做任何其他的处理，加载完成后挂载到一个导出对象上，在 render 的时候拿到这个导出对象的属性然后以 `\n` 分割获取每一张图片的 base64 串；render 的时候采用的是一个 img 元素，每一帧变化 src 属性同时切换透明度防止闪烁。这种方案避免了 js 处理巨大 JSON 文件时的消耗，同时采用一个 img DOM 元素进行渲染，避免了 new Image 带来的消耗。其实这种方案在 1242 * 1242 的图片情况下，同样是不通过的，后来我们还是进行了压缩图片的处理。

到这里，这块的问题我们算是解决了。接下来又出现了一个问题，由于这个项目最终是要在手机百度 APP 上以语音搜索的形式进入，手百 APP 语音搜索后打开的运营页面是运行在他们的 O2O 框架中，这个框架网页渲染能力比手百 APP 要差一些，而且有一个很奇葩的特点，就是当 url 发生变化时（包括加上一个 `#`），框架就认为页面重新渲染了，就会去触发页面上 ajax 请求，而在 ios 端，为了良好的用户体验，加载请求的时候框架会自动生成一个 `正在加载...` 的 loading 提示。所以当时我们的问题就是切换页面时，突然出现一个 `正在加载...` 的提示框，而且时间很长，我们判断这个请求是在加载预先生成好的 base64 文本文件，后来把加载所有 base64 文本文件的请求全部写在第一个页面。但这也没用，到那个页面切换的时候还会出现，然后经过排查，才知道是切换页面的 `a` 标签元素没有阻止默认事件，导致页面 url 上出现了 `#`，框架会触发 ajax 请求，阻止了默认事件之后，这个问题也就解决了。

主要的问题就是上面这些了，当然也有一些其他的问题，比如 base64 文件存放在哪，如何去加载？最开始我们把文件放在 edp bcs 上（线上服务器对 baidu 域名有白名单，不会跨域），直接 ajax 加载，后来发现 edp bcs 上传的服务器没有开启 `gzip`，对二次访问性能有一些影响。因此放到了一个静态资源服务器上，这个服务器会跨域，所以最终采用 jsonp 去加载这些 base64 文本文件。

还有就是 android audio 的播放问题，播放音频，我们采用的是 `Howler`，但在某些 android 系统上无法播放，后来我们采用的是切换到需要播放音频的页面时，动态创建 audio 标签来实现播放。

### 总结

全息这个项目比较极端，但正因为如此，积累了特殊、丰富的经验，后续再遇上此类项目时，定会处理得游刃有余。